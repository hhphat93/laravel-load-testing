version: '3'
services:
  loadbalance:
    build:
      context: .
      dockerfile: Dockerfile
    image: server_ubuntu
    container_name: lb
    ports:
      - 9000:80
      - 444:443
    volumes:
      - ./server_loadbalance/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./server_loadbalance/nginx/sites-available:/etc/nginx/sites-available
      - ./server_loadbalance/log:/var/log/nginx
      - ./server_loadbalance/ssl/:/etc/nginx/ssl
    tty: true
    networks:
      - docker_server_network
      - docker_share_network
    cpus: 2.0
    mem_limit: 3g

  # server ubuntu 1
  ubuntu1:
    image: server_ubuntu
    depends_on: 
      - loadbalance
    container_name: u1
    ports:
      - 9001:80
      - 6001:6001
    volumes:
      - ./html:/var/www/html
      - ./server_ubuntu1/log/nginx:/var/log/nginx
      - ./server_ubuntu1/log/php-fpm:/var/log/php-fpm
      - ./server_ubuntu1/php:/etc/php/
      - ./server_ubuntu1/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./server_ubuntu1/nginx/sites-available:/etc/nginx/sites-available
    working_dir: /var/www/html
    tty: true
    networks:
      - docker_server_network
      - docker_share_network
    cpus: 2.0
    mem_limit: 3g

  # server ubuntu 2
  ubuntu2:
    image: server_ubuntu
    depends_on: 
      - loadbalance
    container_name: u2
    ports:
      - 9002:80
    volumes:
      - ./html:/var/www/html
      - ./server_ubuntu2/log/nginx:/var/log/nginx
      - ./server_ubuntu2/log/php-fpm:/var/log/php-fpm
      - ./server_ubuntu1/php:/etc/php/
      - ./server_ubuntu2/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./server_ubuntu2/nginx/sites-available:/etc/nginx/sites-available
    working_dir: /var/www/html
    tty: true
    networks:
      - docker_server_network
      - docker_share_network
    cpus: 2.0
    mem_limit: 3g

  # database master
  mysql_master:
    image: mysql:5.7.44
    env_file:
      - ./db_master/mysql_master.env
    container_name: "mysql_master"
    command: --default-authentication-plugin=mysql_native_password
    restart: "no"
    ports:
      - 33306:3306
    volumes:
      - ./db_master/conf:/etc/mysql/conf.d
      - ./db_master/log:/var/log/mysql
      - mysql_master_data:/var/lib/mysql
      - ./db_sample/test_db-master:/opt/test_db-master
    networks:
      - docker_server_network
      - docker_share_network
    cpus: 2.0
    mem_limit: 3g

  # database slave
  mysql_slave:
    image: mysql:5.7.44
    env_file:
      - ./db_slave/mysql_slave.env
    container_name: "mysql_slave"
    command: --default-authentication-plugin=mysql_native_password
    ports:
      - 33307:3306
    depends_on:
      - mysql_master
    volumes:
      - ./db_slave/conf:/etc/mysql/conf.d
      - ./db_slave/log:/var/log/mysql
      - mysql_slave_data:/var/lib/mysql
    networks:
      - docker_server_network
      - docker_share_network
    cpus: 2.0
    mem_limit: 3g

  # database slave 2
  mysql_slave_2:
    image: mysql:5.7.44
    env_file:
      - ./db_slave_2/mysql_slave.env
    container_name: "mysql_slave_2"
    command: --default-authentication-plugin=mysql_native_password
    ports:
      - 33308:3306
    depends_on:
      - mysql_master
    volumes:
      - ./db_slave_2/conf:/etc/mysql/conf.d
      - ./db_slave_2/log:/var/log/mysql
      - mysql_slave_2_data:/var/lib/mysql
    networks:
      - docker_server_network
      - docker_share_network
    cpus: 2.0
    mem_limit: 3g
  
  # redis
  redis:
    image: redis:7.2.3
    container_name: "server_redis"
    ports:
      - 6379:6379
    command: [
        "redis-server", 
        "--appendonly", 
        "no", 
        "--maxmemory", 
        "500mb", 
        "--maxmemory-policy", 
        "allkeys-lru",
        "--save",
        "60",
        "1000",
        "--loglevel",
        "warning",
      ]
    volumes: 
      - redis_data:/data
    networks:
      - docker_server_network
      - docker_share_network
    cpus: 2.0
    mem_limit: 3g

volumes:
  mysql_master_data:
    driver: local
  mysql_slave_data:
    driver: local
  mysql_slave_2_data:
    driver: local
  redis_data:
    driver: local

networks:
  docker_server_network:
    driver: bridge
  docker_share_network:
    external: true

